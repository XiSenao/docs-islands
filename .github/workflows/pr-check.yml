name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  CI: true
  FORCE_COLOR: 1

jobs:
  # å¿«é€Ÿè´¨é‡æ£€æŸ¥
  quick-check:
    name: Quick Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # éœ€è¦å®Œæ•´å†å²ä»¥è¿›è¡Œ diff

      - name: Check PR Size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}..HEAD | tail -1 | awk '{print $4}')

          echo "ğŸ“Š PR Statistics:"
          echo "- Files changed: $FILES_CHANGED"
          echo "- Lines changed: $LINES_CHANGED"

          if [ $FILES_CHANGED -gt 50 ]; then
            echo "âš ï¸ Warning: Large PR detected (>50 files)"
            echo "Consider breaking this into smaller PRs"
          fi

      - name: Validate Commit Messages
        uses: ./.github/actions/validate-commits
        with:
          strict_mode: false # Set to true to fail on style warnings

  # å¹¶è¡Œè¿è¡Œçš„è½»é‡çº§æ£€æŸ¥
  parallel-checks:
    name: ${{ matrix.check }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check:
          - "Lint"
          - "Type Check"
          - "Format"
          - "Unit Tests"
    steps:
      - uses: actions/checkout@v5

      - name: Setup Environment
        uses: ./.github/actions/setup-env
        with:
          node-version: 22
          playwright: ${{ matrix.check == 'Unit Tests' }}

      - name: Run ${{ matrix.check }}
        run: |
          case "${{ matrix.check }}" in
            "Lint")
              pnpm lint --max-warnings 0
              ;;
            "Type Check")
              pnpm typecheck
              ;;
            "Format")
              pnpm prettier --check .
              ;;
            "Unit Tests")
              pnpm test:unit --reporter=github-actions
              ;;
          esac

      # ä¸ºå¤±è´¥çš„æ£€æŸ¥æä¾›ä¿®å¤å»ºè®®
      - name: Provide Fix Suggestions
        if: failure()
        run: |
          case "${{ matrix.check }}" in
            "Lint")
              echo "ğŸ’¡ To fix lint issues, run: pnpm lint --fix"
              ;;
            "Format")
              echo "ğŸ’¡ To fix format issues, run: pnpm format"
              ;;
            "Type Check")
              echo "ğŸ’¡ Review TypeScript errors and update type definitions"
              ;;
          esac

  # PR è¯„è®ºå’Œæ ‡ç­¾
  pr-feedback:
    name: PR Feedback
    runs-on: ubuntu-latest
    needs: [quick-check, parallel-checks]
    if: always()
    steps:
      - uses: actions/checkout@v5

      - name: Setup Environment
        uses: ./.github/actions/setup-env
        with:
          node-version: 22

      # è¿è¡Œè½»é‡çº§åˆ†æ
      - name: Bundle Size Analysis
        id: bundle
        run: |
          pnpm build
          echo "## ğŸ“¦ Bundle Size Report" > bundle-report.md
          echo "| Package | Size | Gzip |" >> bundle-report.md
          echo "|---------|------|------|" >> bundle-report.md

          # åˆ†æå„ä¸ªåŒ…çš„å¤§å°
          for pkg in packages/*/dist; do
            if [ -d "$pkg" ]; then
              PKG_NAME=$(basename $(dirname $pkg))
              SIZE=$(du -sh $pkg | awk '{print $1}')
              echo "| $PKG_NAME | $SIZE | - |" >> bundle-report.md
            fi
          done
        continue-on-error: true

      - name: Test Coverage Report
        id: coverage
        run: |
          pnpm test:unit --coverage --silent > coverage.txt 2>&1 || true
          if grep -q "Coverage summary" coverage.txt; then
            echo "## â˜‚ï¸ Coverage Report" > coverage-report.md
            sed -n '/Coverage summary/,/^$/p' coverage.txt >> coverage-report.md
          fi
        continue-on-error: true

      # åˆ›å»º PR è¯„è®º
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ¤– Automated PR Review\n\n';

            // æ·»åŠ æ£€æŸ¥çŠ¶æ€
            comment += '### âœ… Checks Status\n';
            comment += `- Quick Check: ${{ needs.quick-check.result == 'success' && 'âœ…' || 'âŒ' }}\n`;
            comment += `- Parallel Checks: ${{ needs.parallel-checks.result == 'success' && 'âœ…' || 'âŒ' }}\n\n`;

            // æ·»åŠ  bundle æŠ¥å‘Š
            if (fs.existsSync('bundle-report.md')) {
              comment += fs.readFileSync('bundle-report.md', 'utf8') + '\n';
            }

            // æ·»åŠ è¦†ç›–ç‡æŠ¥å‘Š
            if (fs.existsSync('coverage-report.md')) {
              comment += fs.readFileSync('coverage-report.md', 'utf8') + '\n';
            }

            // æ·»åŠ å»ºè®®
            comment += '### ğŸ’¡ Next Steps\n';
            if ('${{ needs.parallel-checks.result }}' !== 'success') {
              comment += '- Fix failing checks by running `pnpm lint --fix` and `pnpm format`\n';
            }
            comment += '- Ensure all tests pass locally with `pnpm test`\n';
            comment += '- Review the changes in the Files tab\n';

            // æŸ¥æ‰¾å¹¶æ›´æ–°ç°æœ‰è¯„è®ºï¼Œæˆ–åˆ›å»ºæ–°è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– Automated PR Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      # è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
      - name: Add Labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [];

            // æ ¹æ®æ–‡ä»¶å˜åŒ–æ·»åŠ æ ‡ç­¾
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const hasDocsChanges = files.some(f => f.filename.startsWith('docs/'));
            const hasTestChanges = files.some(f => f.filename.includes('test'));
            const hasCIChanges = files.some(f => f.filename.startsWith('.github/'));

            if (hasDocsChanges) labels.push('documentation');
            if (hasTestChanges) labels.push('testing');
            if (hasCIChanges) labels.push('ci/cd');

            // æ ¹æ® PR å¤§å°æ·»åŠ æ ‡ç­¾
            if (files.length < 5) {
              labels.push('size/small');
            } else if (files.length < 15) {
              labels.push('size/medium');
            } else {
              labels.push('size/large');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
